<%= tinymce_assets %>
<%= tinymce language: 'pt_BR' %>
<%= form_with(model: answer, local: true) do |form| %>
<% if answer.errors.any? %>
  <div id="error_explanation">
    <h2><%= pluralize(answer.errors.count, "error") %>
      prohibited this answer from being saved:</h2>

    <ul>
      <% answer.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>
<div class="form" style="max-width: 700px">
  <div class="required_info"></div><br/>
  <div class="field">
    <%= form.label :question, 'Questão', class: 'required' %>
    <% if @question %>
      <%= form.text_field :question, value: @question.title, required: true %>
    <% else %>
      <%= form.text_field :question, class: 'form-control boxed', required: true %>
    <% end %>
  </div>

  <div class="field">
    <%= form.label :answer, 'Resposta', class: 'required' %>
    <% if @reply %>
      <%= form.text_area :answer,id:'tinymce', class: 'tinymce', value: strip_tags(@reply.description.gsub("&nbsp;", "")), rows: 15 %>
    <% else %>
      <%= form.text_area :answer, id:'tinymce', class: 'tinymce', rows: 15 %>
    <% end %>
  </div>

  <div class="field">
    <%= form.label :keywords, 'Palavras-chave (separadas por vírgula ou ponto-e-vírgula)', class: 'required' %>
    <%= form.text_field :keywords, 'data-role': 'tagsinput', placeholder: ' ' %>
  </div>

  <div class="form-group">
    <%= form.label :file, 'Arquivos (selecione todos os arquivos necessários pressionando a tecla CTRL)' %>
    <%= form.file_field :file, class: 'form-control boxed', multiple: true, onchange: 'validateFiles(this)', data: {max_file_size: 20.megabytes, max_file_quantity: 10}%>
  </div>

  <% text = 'display: none' %>
    <% if @question %>
      <div class="field" style="display: none">
        <%= form.label :category_id, 'Categoria', class: 'required' %>
        <%= form.text_field :category_id, value: @question.category.id, required: true %>

      </div>
      <%= hidden_field_tag :question_id, @question.id %>
    <% else %>
      <div class="field">
        <%= form.label :category_id, 'Categoria', class: 'required' %>
        <select class="form-control boxed" required="required" name="answer[category_id]" id="answer_category_id">
          <option value>Selecione uma categoria:</option>
          <%= inside_layout "categories/category_select", {categ: Category.all} do %>
            <%= yield %>
          <% end %>
        </select>
      </div>
    <% end %>

    <div class="field" style="display: none">
      <%= form.label :user_id, 'Usuário', class: 'required' %>
      <%= form.text_field :user_id, value: current_user.id, required: true %>
    </div>

    <% unless @reply && @reply.faq == true %>
      <div class="form-check form-check-inline" hidden="hidden">
        <%= form.check_box :faq, class: "form-check-input", checked: true %>
        <%= form.label :faq, value: 'Adicionar ao FAQ?', class: 'form-check-label' %>
      </div>
      <br/>
    <% end %>

    <%= form.submit 'Salvar Questão',:class => 'btn btn-primary btn-sm' %>
    <%= link_to 'Cancelar', faq_path, :class => 'btn btn-danger btn-sm' %>

  </div>
<% end %>

<script>
  function validateFiles(inputFile) {

    var size = 0;
    var maxFileSize = $(inputFile).data('max-file-size');
    var maxFileQuantity = $(inputFile).data('max-file-quantity');

    $.each(inputFile.files, function () {
      if (this.size) {
        size += this.size;
      }
    });

    if (size && maxFileSize && size > parseInt(maxFileSize)) {
      const animation = {
        "in": "bounceIn",
        "out": "fadeOutUpBig"
      };
      const heart = "/assets/icons/logo-ffea90fdc94f5f4a6d88ec21782b2433fe67e0a8883a9950c468a55cf8d53e00.png";
      Notification.create("<%= 'Alerta' %>", '<%= "Esses anexos excedem o tamanho máximo permitido (20 MB)" %>', heart, animation, 2, 5);
      $(inputFile).val('');
    } else if (inputFile.files.length > maxFileQuantity) {
      const animation = {
        "in": "bounceIn",
        "out": "fadeOutUpBig"
      };
      const heart = "/assets/icons/logo-ffea90fdc94f5f4a6d88ec21782b2433fe67e0a8883a9950c468a55cf8d53e00.png";
      Notification.create("<%= 'Alerta' %>", '<%= "Esses anexos excedem a quantidade máxima permitida (10 arquivos)" %>', heart, animation, 2, 5);
      $(inputFile).val('');
    };
  }
</script>
