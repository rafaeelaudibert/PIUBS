<%= form_with(model: controversy, local: true) do |form| %>
  <% if controversy.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(controversy.errors.count, "error") %> prohibited this controversy from being saved:</h2>

      <ul>
      <% controversy.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= form.label :title %>
    <%= form.text_field :title %>
  </div>

  <div class="field">
    <%= form.label :description %>
    <%= form.text_field :description %>
  </div>

  <div class="field">
    <%= form.label :protocol %>
    <%= form.text_field :protocol %>
  </div>

  <div class="field">
    <%= form.label :closed_at %>
    <%= form.datetime_select :closed_at %>
  </div>

  <div class="field">
    <%= form.label :sei %>
    <%= form.number_field :sei %>
  </div>

  <div class="field">
    <%= form.label :contract_id %>
    <%= form.number_field :contract_id %>
  </div>

  <div class="field">
    <%= form.label :city_id %>
    <%= form.number_field :city_id %>
  </div>

  <div class="field">
    <%= form.label :cnes %>
    <%= form.number_field :cnes %>
  </div>

  <div class="field">
    <%= form.label :company_user_id %>
    <%= form.number_field :company_user_id %>
  </div>

  <div class="field">
    <%= form.label :unity_user_id %>
    <%= form.number_field :unity_user_id %>
  </div>

  <div class="field">
    <%= form.label :category %>
    <%= form.select :category, Controversy.categories.map(&:first) %>
  </div>

  <div class="field">
    <%= form.label :complexity %>
    <%= form.number_field :complexity %>
  </div>

  <div class="field">
    <%= form.label :support_1_id %>
    <%= form.number_field :support_1_id %>
  </div>

  <div class="field">
    <%= form.label :support_2_id %>
    <%= form.number_field :support_2_id %>
  </div>

  <div class="form-group">
    <%= form.label :files, 'Arquivos (selecione todos os arquivos necessários pressionando a tecla CTRL)' %>
    <%= form.text_field :files, id:'uuid-files', class: 'hidden'%>
    <div id="dropzone" class="future-dropzone">
      <div class="dz-default dz-message">
        Arraste arquivos aqui para adicioná-los
      </div>
    </div>
  </div>

  <div class="actions">
    <%= form.submit %>
  </div>
<% end %>

<script>

let fileIds = [];

$(document).ready(() => {

  // Adds the actual class, to prevent errors
  document.querySelector('.future-dropzone').classList.add('dropzone');

    // grap our upload form by its id
  $('#dropzone').dropzone({
      url: '/apoioaempresas/attachments',

      // restrict image size to a maximum 20MB
      maxFilesize: 20,

      // restrict to the maximum of 5 files
      maxFiles: 5,

      // Translations
      dictCancelUpload: 'Cancelar Upload',
      dictCancelUploadConfirmation: 'Deseja mesmo cancelar o Upload?',
      dictRemoveFile: 'Remover arquivo',
      dictDefaultMessage: 'Arraste arquivos aqui para adicioná-los',
      dictFallbackMessage: 'Esse browser não suporta o anexo de arquivos.',
      dictFileTooBig: 'Tamanho dos anexos excedido',
      dictInvalidFileType: 'Extensão de arquivo Inválida',
      dictMaxFilesExceeded: 'Quantidade de arquivos excedida',

      // show remove links on each image upload
      addRemoveLinks: true,

      // if the upload was successful
      success: (file, response) => {
          // find the remove button link of the uploaded file and give it an id
          // based of the attachmentID response from the server
          $(file.previewTemplate).find('.dz-remove').attr('id', response.attachmentID);

          // Add to array
          fileIds.push(response.attachmentID);
          $('#uuid-files').val(fileIds);

          // add the dz-success class (the green tick sign)
          $(file.previewElement).addClass("dz-success");

      },
      //when the remove button is clicked
      removedfile: file => {

          // grap the id of the uploaded file we set earlier
          let id = $(file.previewTemplate).find('.dz-remove').attr('id');

          // Remove from array
          fileIds = fileIds.filter(uuid => uuid != id)
          $('#uuid-files').val(fileIds);

          // make a DELETE ajax request to delete the file
          $.ajax({
              type: 'DELETE',
              url: '/apoioaempresas/attachments/' + id,
              success: () => $(file.previewTemplate).fadeOut(),
              error: e => console.error(e)
          });
      }
  });
})


</script>
